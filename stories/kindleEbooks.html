<!DOCTYPE html><html><head><link rel="stylesheet" href="https://abjurato.github.io/general.css" type="text/css"/><title>Amazon Kindle: iOS App Reverse Engineering for eBooks Leaking</title><meta name="twitter:title" content="Amazon Kindle: iOS App Reverse Engineering for eBooks Leaking"/><meta name="og:title" content="Amazon Kindle: iOS App Reverse Engineering for eBooks Leaking"/><meta name="twitter:image" content="https://abjurato.github.io/images/4.jpeg"/><meta name="og:image" content="https://abjurato.github.io/images/4.jpeg"/><meta name="twitter:card" content="summary"/><meta name="description" content="Amazon Kindle: iOS App Reverse Engineering for eBooks Leaking"/><meta name="twitter:description" content="Amazon Kindle: iOS App Reverse Engineering for eBooks Leaking"/><meta name="og:description" content="Amazon Kindle: iOS App Reverse Engineering for eBooks Leaking"/><link rel="canonical" href="https://abjurato.github.io/stories/kindleEbooks.html"/><meta name="twitter:url" content="https://abjurato.github.io/stories/kindleEbooks.html"/><meta name="og:url" content="https://abjurato.github.io/stories/kindleEbooks.html"/></head><body class="comment"><a href="https://abjurato.github.io/">(lldb) thread step-out</a><h1>Amazon Kindle: iOS App Reverse Engineering for eBooks Leaking</h1><div><i>Disclaimer: this was written back in February 2020.</i></div><br/><p>I read a lot, and love non-fiction. But when it comets to ebooks, I prefer native Books.app of iOS - I got used to its controls, animations, and feeling of a "one-stop shop" for all the books I've read lately. So, every time I happen to buy a ebook, first thing I look for is - how can this book be imported into Books.app?</p><p>After <a href="https://abjurato.github.io/stories/alpinaEbooks.html">easy success</a> with Alpina.Books app, I've decided to check out the state of the art - ebooks protection in <a href="https://apps.apple.com/us/app/amazon-kindle/id302584613">Amazon Kindle</a> application for iOS.</p><h2>File System Artefacts</h2><p>Similarly, analyst starts with pulling app data from iOS device onto my mac. As one can remember from previous blogpost, apps have two readable/writable directories to store data produced during app runtime: directory of the app itself and AppGroups directories for sharing data between multiple apps (or app extensions) of one developer. Access to AppGroups is managed by system AppleMobileFileIntegrity.kext according to <i>entitlements</i> that are baked into <i>code signature</i>. In order to know which AppGroups the app is allowed access to, we too can read entitlements of the bundle.</p><p>Fetching app bundle is not a big issue: run Filza file manager on a jailbroken device and find the bundle under <span class="inlinecode">/var/containers/Bundle/Application/</span>, and transfer it to the mac via SSH using <span class="inlinecode">scp</span> command. A famous <span class="inlinecode">ldid</span> tool helps us to dump entitlements of the bundle:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_01.png"/></div>Okay, here we see that app has access to AppGroup with identifier <i>group.com.amazon.Lassen</i> and a similarly named shared Keychain. Unfortunately, in my case directory of this group was empty :)</p><p>On the other hand, working directory of the app itself has a lot of stuff and even a folder called eBooks with a number of subfolders:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_02.png"/></div></p><p>There's also an SQL database at <span class="inlinecode">Library/Preferences/BookData.sqlite</span> with a table named <span class="inlinecode">ZBOOK</span>, where each book has a familiar title in <span class="inlinecode">ZSORTTITLE</span> and a local URL in <span class="inlinecode">ZPATH</span>:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_03.png"/></div></p><p>Open one of these URLs and check the contents, and make sure <span class="inlinecode">ZMIMETYPE</span> value <i>application/x-kfx-ebook</i> did not lie - the book contents are stored in a proprietary Amazon format with a built-in DRM (witch at the time of writing is not publicly broken):<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_04.png"/></div>Okay, this looks like a dead end for me - I'm not a cryptography and DRM expert. Let's try to understand how the app itself decrypts these files maybe?</p><h2>Static Analysis</h2><p><i>All executable binaries of AppStore apps are encrypted and signed - literally part of the Mach-O binary is encrypted and is decrypted only in memory during app launch by launchd system daemon. Hence the easiest way for us to obtain a decrypted binary (that we'll be able to disassemble to peek at its code) is to dump the decrypted part of it from device memory after launch and replace the encrypted chunk in the binary that we've already downloaded to the Mac. Additionally, if we'll want to run this binary later, we need to modify Mach-O launch commands (that sit in the beginning of the binary and explain to the system how this binary should be launched) to say that size of encrypted part is 0. This process is explained in more detail in one of my </i><a href="https://abjurato.github.io/topcards/decrypt_binary.html">cards</a>.</p><p>For this part we'll need a decrypted binary of the app. First of all, lets run a classic tool <span class="inlinecode">class-dump</span> that will read appropriate section of the binary and re-create headers for Objective-C classes mentioned there:<span class="snippet">abjurato@Macintosh Desktop % ./class-dump -H -o &lt;OURPUT_PATH&gt; &lt;PATH_TO_BINARY&gt;</span><div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_05.png"/></div></p><p>Okay, good news is that the app is written in Objective-C, but that's a lot of files. Which should we pay attention to? Let's open the binary in Hopper Disassembler and try to find some object or method with a hit in its name, like this one:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_06.png"/></div></p><p>Seemingly, object <span class="inlinecode">KfxBookBundle</span> represents book at some level of abstraction, let's check it's headers dump: it has a property called <span class="inlinecode">allPieces</span>. If we'll run the app on device with a debugger connected, put a symbolic breakpoint at <span class="inlinecode">-[KfxBook initWithBundle:]</span> and try to open one of the books, we'll see that this property contains an array of <span class="inlinecode">KfxBookPiece</span> objects:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_07.png"/></div></p><p>Looking at the code of <span class="inlinecode">KfxBookBundle</span> constructor, we can notice that it reads <b>BookManifest.kfx</b> file as a CoreData database with a model named similarly - <b>KfxBookBundle</b>:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_08.png"/></div>Let's try to change <b>.kfx</b> extension to <b>.sqlite</b> in one of the files we've obtained from from application working directory and open it. Looks like it's just a manifest tying together all files in a bundle:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_09.png"/></div>After hours of debugging and reading assembly, I've bumped into non-Objective-C and non-Swift code seemingly responsible for reading the contents of files and settings up environment to decrypt parts of the book file on-demand. Probably, this code is a library shared across all different Kindle readers - from iOS to Android to Amazon devices - and is linked statically into the iOS binary.</p><h2>Dynamic Analysis</h2><p>Let's go opposite way - from UI down to business logic. In the end of the day, the text is somehow rendered on the screen! I'll omit the details of connecting debugger to the application - the manual process is complicated but Frida 'just works'.</p><p>After launching the app and opening a book, let's stop the process and ask lldb which UIViewController is currently presented:<span class="snippet">(lldb) po [[[[UIApplication sharedApplication] keyWindow] rootViewController] presentedViewController]</span><span class="snippet"><i>&lt;ReaderViewController: 0x1050ca600&gt;</i></span></p><p>Looking at endless headers of this file, we notice <span class="inlinecode">ReaderModel</span> reference, and <span class="inlinecode">ReaderModel</span> object has a reference to <span class="inlinecode">BookMainData</span> which inherits from <span class="inlinecode">NSManagedObject</span>, whose values we've seen in <span class="inlinecode">ZBOOK</span> table of the main database:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_10.png"/></div></p><p>This binary is a “stripped” one, so we can not use names of methods and classes to set debugger breakpoints. We'll have to call Objective-C runtime <span class="inlinecode">objc_getClass</span> and <span class="inlinecode">class_getMothodImplementation</span> functions to define the addresses of methods of interest in the process memory instead. Setting a breakpoint in <span class="inlinecode">openBookWithBookId</span> method of <span class="inlinecode">ReaderViewController</span> looks like this:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_11.png"/></div></p><p>From the <span class="inlinecode">ReaderViewController</span> header we can see that it has references to <span class="inlinecode">ReaderItem</span> and <span class="inlinecode">KindleDocument</span> objects:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_12.png"/></div>Where <span class="inlinecode">_barePronter</span> looks interesting. Disassembler shows that a property with this names it used in <span class="inlinecode">-[BookTextExtractor textInfoForKindleDocument: forBookPositionRange]</span> method:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_13.png"/></div>And if we'll add a breakpoint in the constructor of <span class="inlinecode">-[BookTextExtractorInfo initWithText:andWordCount:]</span> and read the argument value, we'll see a chunk of text that presents on the screen:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_14.png"/></div></p><p>Can we trick the caller into passing there a longer chunk? After some time I've found a sibling method <span class="inlinecode">-[BookTextExtractor textInfoForBookPositionRange:usingIterator:]</span> that is called in order to determine what is the language of the text on the screen and set up a build-in Google translator:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_15.png"/></div>This basically means that we only need to create a <span class="inlinecode">BookPositionRange</span> object with valid start and end <span class="inlinecode">BookPosition</span> values and pass to this method - and get all the text between these positions (later I'll notice that this text lacks any formatting).</p><p>Digging deeper, we'll notice that <span class="inlinecode">ReaderViewController</span> has a reference to <span class="inlinecode">KfxDocViewController</span> with a reference to <span class="inlinecode">KfxPagePreviewModel</span> which knows the positions of the beginnings of all chapters:<div class="screenshot"><img src="https://abjurato.github.io/images/kindleEbooks_16.png"/></div></p><p>Such way, a sequence of lldb commands to dump raw text of a chapter will look like this:<div class="gist"><script src="https://gist.github.com/abjurato/b6a2fe170e31a4173b71f38d31ad8213.js"></script></div>Done!</p><h2>Summary</h2><p>Hooray? Probably. The process of breakpoints creation and chapters enumeration may be automated using lldb build-in Python scripting capability, but the lack of formatting is a problem to stay - sentences of dialogues are all merged together, and titles are stuck to the paragraphs, and paragraphs are not separated. I personally was not satisfied with this output and resorted to use the Kindle app for ebooks bought from Amazon.</p><br/><h2>Sources and Tools</h2><p><a href="https://www.objc.io/issues/17-security/inside-code-signing/">[0] Inside Code Signing</a></p><p><a href="https://www.theiphonewiki.com/wiki/AppleMobileFileIntegrity">[1] AppleMobileFileIntegrity</a></p><p><a href="https://iphonedevwiki.net/index.php/Ldid">[2] About ldid tool for codesigning</a></p><p><a href="https://derekselander.github.io/dsdump/">[3] Building a class-dump in 2020</a></p><p><a href="https://www.hopperapp.com">[4] Hopper Disassembler</a></p><p><a href="https://frida.re/docs/ios/">[5] Frida for dynamic analysis</a></p><p><a href="https://stackoverflow.com/a/42232823/4751521">[6] Setting a breakpoint in a stripped binary with LLDB</a></p><p><a href="https://lldb.llvm.org/use/python.html">[7] LLDB - Python Scripting</a></p><br/><div class="comment">11/10/2020</div></body></html>